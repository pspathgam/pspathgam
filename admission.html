<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admission Management - GPS Pethgam Wagoora</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    /* --- GENERAL STYLES --- */
    body{
        font-family: Arial, sans-serif;
        background:#eef7ff;
        margin:0;
        padding:20px;
    }
    .tab-buttons{
        display:flex;
        gap:10px;
        margin-bottom:20px;
        justify-content: center;
    }
    .tab-buttons button{
        background:#0b76ef;
        color:white;
        padding:10px 22px;
        border:none;
        border-radius:6px;
        font-weight:bold;
        cursor:pointer;
        box-shadow:0px 4px 0px #064a97;
        transition:0.1s;
    }
    .tab-buttons button.active {
        background: #004d99;
        box-shadow:0px 2px 0px #064a97;
    }
    .tab-buttons button:active{
        box-shadow:0px 1px 0px #064a97;
        transform:translateY(3px);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .container{
        background:white;
        padding:20px;
        border-radius:8px;
        box-shadow:0px 0px 10px #bcd4ff;
        max-width:850px; 
        margin:auto;
    }
    /* --- HEADER STYLES (Screen) --- */
    .header-content {
        display: flex; align-items: center; justify-content: center; 
        margin-bottom: 20px; text-align: center; border-bottom: 2px solid #ccc;
        padding-bottom: 15px;
    }
    .school-logo {
        height: 80px; width: 80px; margin-right: 20px; border: 1px solid #ccc; 
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%; font-size: 10px; color: #555; font-weight: bold;
    }
    h2{ margin-top:0; margin-bottom: 5px; font-size: 24px; color: #0b76ef; }
    .header-text p { margin: 0; font-size: 12px; color: #555; }
    /* --- FORM STYLES --- */
    label{ display:block; margin-top:10px; font-weight:bold; }
    .form-row { display: flex; gap: 15px; margin-bottom: 10px; }
    .form-group { flex: 1; min-width: 0; }
    .form-group label { margin-top: 0; font-size: 14px; font-weight: normal; }
    input, select{
        width:100%; padding:8px; margin-top:5px; border-radius:4px;
        border:1px solid #999; box-sizing: border-box;
    }
    .section-title{
        font-size:18px; margin-top:25px; font-weight:bold; 
        text-decoration:underline; color: #0b76ef;
    }
    /* --- BUTTON STYLES --- */
    .submit-btn, #openApaarForm {
        background:#28a745; color:white; padding:12px; border:none; 
        border-radius:6px; width:48%; font-size:18px; margin-top:20px;
        cursor:pointer; font-weight:bold; box-shadow:0px 4px 0px #0c6c25;
        transition:0.1s;
    }
    #openApaarForm {
        background:#0b76ef;
        box-shadow:0px 4px 0px #064a97;
    }
    .form-actions {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    .action-buttons {
        display: flex; gap: 10px; margin-top: 20px; justify-content: center;
    }
    .pdf-btn {
        background:#dc3545; color:white; padding:10px 15px; border:none;
        border-radius:6px; font-weight:bold; cursor:pointer;
        box-shadow:0px 4px 0px #970617; transition:0.1s; font-size: 16px;
        flex-grow: 1; max-width: 250px;
    }
    /* --- TEMPLATE STYLES for PDF Print --- */
    .apaar-form-template, .print-form-template {
        max-width: 210mm; 
        margin: 0 auto; 
        padding: 5mm; 
        box-sizing: border-box;
        background: white;
        font-family: Arial, sans-serif;
    }
    .print-form-template {
        border: 1px solid #000; 
        font-size: 12px;
        line-height: 1.2; 
    }
    /* PDF Header Styling FIX */
    .pdf-header-content {
        display: flex; 
        align-items: center; 
        justify-content: center; 
        margin-bottom: 2px; 
        text-align: center; 
        border-bottom: 2px solid #ccc;
        padding-bottom: 2px; 
        padding-top: 0; 
    }
    .pdf-header-content .header-text {
        text-align: center;
        line-height: 1.1; /* Tighter line height for two lines */
    }
    .pdf-header-content h3 {
        color: #000; 
        margin: 0; /* Remove default margins */
        /* Adjusted font size for two-line fit */
        font-size: 11px; 
        white-space: normal; 
    }
    .pdf-header-content p {
        margin: 0; 
        font-size: 9px; 
    }
    .print-form-template h3 {
        margin-top: 5px; 
        margin-bottom: 5px; 
        font-size: 16px;
    }
    .print-box {
        border: 1px solid #000;
        padding: 3px 5px; 
        margin-bottom: 3px; 
        display: flex;
        flex-wrap: wrap;
    }
    .print-field {
        display: flex;
        align-items: flex-end;
        padding: 1px 0;
    }
    .print-label {
        font-weight: bold;
        white-space: nowrap;
        margin-right: 5px;
        font-size: 11px;
    }
    .print-value {
        flex-grow: 1;
        border-bottom: 1px dashed #000;
        min-width: 50px;
        padding: 0 5px;
        font-size: 12px;
        /* FIX: Prevent wrapping of long names and force single line display */
        white-space: nowrap; 
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .print-row-group {
        width: 100%; 
        display: flex;
        justify-content: space-between;
    }
    /* Page break for printing */
    .page-break {
        page-break-before: always;
    }
    /* Signature Area Styling FIX */
    .signature-area {
        display: flex;
        justify-content: space-around;
        margin-top: 20px; 
        font-size: 11px;
    }
    .signature-box {
        flex: 1;
        text-align: center;
        padding-top: 20px; /* Space for signature */
        border-top: 1px solid #000;
        margin: 0 10px;
    }
    /* Register Table Styles */
    .register-table .action-btn {
        padding: 4px 8px;
        margin: 2px;
        font-size: 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    .register-table .accept { background-color: #28a745; color: white; }
    .register-table .reject { background-color: #ffc107; color: black; }
    .register-table .delete { background-color: #dc3545; color: white; }
    /* Utility class for hiding elements during print */
    .hidden-for-print { display: none !important; }
</style>

</head>
<body>

<div class="tab-buttons print-exclude"> 
    <button class="active" onclick="showTab('admissionFormTab', this)">Admission Form</button>
    <button onclick="showTab('admissionRegisterTab', this)">Admission Register</button>
    <button onclick="alert('Search functionality coming soon!')">Search Student</button>
</div>

<div id="admissionFormTab" class="tab-content active">
    
    <div class="container" id="admissionFormContainer"> 
        
        <div class="header-content" style="margin-top: 5px;"> 
            <div class="school-logo"> [Logo] </div>
            <div class="header-text">
                <h2>GOVERNMENT PRIMARY SCHOOL PETHGAM WAGOORA</h2>
                <p>Wagoora Babareshhi Road Near Zonal Education Office Wagoora<br>
                **Email ID: psspethgam@gmail.com. UDISECode: 01022202207**</p>
            </div>
        </div>
        
        <h3 style="text-align:center;">ADMISSION FORM</h3>

        <form id="admissionForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Student's Full Name (First Name Middle Name Last Name)</label>
                    <input type="text" name="sname_full" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name As Per Aadhaar</label>
                    <input type="text" name="aname_full">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Father's Full Name (First Name Middle Name Last Name)</label>
                    <input type="text" name="fname_full" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Mother's Full Name (First Name Middle Name Last Name)</label>
                    <input type="text" name="mname_full" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Residence</label><input type="text" name="residence" required></div>
                <div class="form-group"><label>District</label><input type="text" name="district" required></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Father's Cell No.</label><input type="text" name="fcontact" required></div>
                <div class="form-group"><label>Mother's Cell No.</label><input type="text" name="mcontact"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Aadhaar Number</label><input type="text" name="aadhaar" maxlength="12"></div>
                <div class="form-group"><label>Date of Birth (in figures)</label><input type="date" name="dob" required></div>
            </div>
            <label>Date of Birth in Words</label>
            <input type="text" name="dob_words">
            <div class="form-row">
                <div class="form-group"><label>Bank Account Number</label><input type="text" name="bank_account"></div>
                <div class="form-group"><label>Bank Name</label><input type="text" name="bank_name"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Bank Branch</label><input type="text" name="bank_branch"></div>
                <div class="form-group"><label>IFSC Code</label><input type="text" name="ifsc_code"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Category</label>
                    <select name="category">
                        <option>SC</option><option>ST</option><option>OBC</option><option>GENERAL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Blood Group</label>
                    <select name="bloodgroup">
                        <option value="">Select</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                        <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Ration Card Number</label><input type="text" name="ration_no"></div>
                <div class="form-group"><label>Ration Card Type</label><input type="text" name="ration_type"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Class Joining</label>
                    <select name="class" required>
                        <option value="">Select Class</option><option>Nursery</option><option>LKG</option><option>UKG</option>
                        <option>1st</option><option>2nd</option><option>3rd</option><option>4th</option><option>5th</option>
                    </select>
                </div>
                <div class="form-group"><label>PEN Number for Transferring Students</label><input type="text" name="pen_number"></div>
            </div>
            <label>Student Photo</label>
            <input type="file" name="student_photo" accept="image/*">
            
            <p class="section-title">Parents Declaration</p>
            <p style="text-align:justify; font-size:14px;">
                I do hereby declare that the above information provided by me is true to the best of my knowledge and belief. 
                I further declare that I will abide by the rules and regulations laid down by the school and the department from 
                time to time and I will co-operate with the institution for the betterment of my ward and institution under rules 
                when sought. I hereby declare that as the Parent of above mentioned student I am giving my consent to provide 
                the AADHAAR for the demographic authentication of the student.
            </p>
            <label style="margin-top: 15px;">
                <input type="checkbox" id="agree" required>
                I agree to the above declaration.
            </label>

            <div class="form-actions">
                <button type="button" id="openApaarForm">Open APAAR Form</button>
                <button type="submit" class="submit-btn">Submit Admission Form</button>
            </div>
        </form>

        <div class="office-use-box" id="officeUseBox" style="margin-top: 25px;">
            <h3 style="text-align:center; margin-top:0;">OFFICE USE ONLY</h3>
            <label>Admission No. Allotted</label>
            <input type="text" name="allotted_adm_no" placeholder="To be filled by Office">

            <div class="form-row">
                <div class="form-group"><label>Class Admitted To</label><input type="text" name="admitted_class"></div>
                <div class="form-group"><label>Date of Admission</label><input type="date" name="admission_date"></div>
            </div>

            <p style="margin-top:15px;font-weight:bold; font-size:14px;">
                The Student is admitted to Class <span style="text-decoration: underline;">________</span> under Admission No. <span style="text-decoration: underline;">________</span> on <span style="text-decoration: underline;">________</span>. 
                All required documents, including the Birth Certificate, Residence Proof, and Transfer Certificate (if applicable), 
                have been duly verified and found satisfactory.
            </p>

            <div class="form-row" style="margin-top: 30px;">
                <div class="form-group"><input type="text"><label>Signature of Parent</label></div>
                <div class="form-group"><input type="text"><label>Sig. Of Adm. Incharge</label></div>
                <div class="form-group"><input type="text"><label>Sig. Of Headmaster</label></div>
            </div>
        </div>
    </div>

    <div class="container print-exclude" style="margin-top: 20px;">
        <p style="text-align: center; font-weight: bold; margin-bottom: 10px;">Download Options (Use after successful data submission)</p>
        <div class="action-buttons">
            <button id="downloadForm" class="pdf-btn" data-target="printFormTemplate">Download Printable Admission Form (Hard Copy)</button>
            <button id="downloadRegister" class="pdf-btn" data-target="officeUseBox">Download PDF Register Record</button>
            <button id="downloadApaar" class="pdf-btn">Download APAAR Consent Form</button>
        </div>
    </div>
</div>

<div id="admissionRegisterTab" class="tab-content">
    <div class="container">
        <h3 style="text-align:center;">ADMITTED STUDENT REGISTER</h3>
        <p style="font-weight: bold;">Filter by Status: 
            <select id="statusFilter" onchange="filterRegister()">
                <option value="All">All</option><option value="Admitted">Admitted</option>
                <option value="In Progress">In Progress</option>
            </select>
        </p>

        <div style="max-height: 500px; overflow-y: auto;">
            <table class="register-table">
                <thead>
                    <tr>
                        <th>S.No</th><th>Date of Submission</th><th>Student Name</th><th>DOB</th>
                        <th>Father's Name</th><th>Class Joining</th><th>Parents Contact</th>
                        <th>Status</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody id="registerBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="printFormTemplate" class="print-form-template" style="display: none;">
    
    <div class="pdf-header-content" style="border-bottom: none; padding-bottom: 2px; margin-top: 0;"> 
        <div class="school-logo" style="height: 50px; width: 50px;"> [Logo] </div>
        <div class="header-text" style="text-align: center; padding-top: 0;">
            <h3>GOVERNMENT PRIMARY SCHOOL</h3>
            <h3 style="margin-top: 0;">PETHGAM WAGOORA</h3>
            <p style="font-size: 9px;">Wagoora Babareshi Road Near ZEO Office Wagoora<br> UDISE CODE 01022202207 Email: pspethgam@gmail.com</p>
        </div>
    </div>
    <h3 style="text-align:center; font-size: 16px; margin-top: 5px; margin-bottom: 5px;">ADMISSION FORM</h3>
    
    <div class="print-box">
        <div class="print-field" style="width: 100%;">
            <span class="print-label">Students Full Name:</span>
            <span class="print-value" data-field="sname_full"></span> 
        </div>
    </div>

    <div class="print-box">
        <div class="print-field" style="width: 100%;">
            <span class="print-label">Name As Per Aadhaar:</span>
            <span class="print-value" data-field="aname_full"></span>
        </div>
    </div>

    <div class="print-box">
        <div class="print-field" style="width: 100%;">
            <span class="print-label">Father's Full Name:</span>
            <span class="print-value" data-field="fname_full"></span>
        </div>
    </div>

    <div class="print-box">
        <div class="print-field" style="width: 100%;">
            <span class="print-label">Mother's Full Name:</span>
            <span class="print-value" data-field="mname_full"></span>
        </div>
    </div>

    <div class="print-box">
        <div class="print-row-group" style="margin-bottom: 0;">
            <div class="print-field print-col-50"><span class="print-label">Residence:</span><span class="print-value" data-field="residence"></span></div>
            <div class="print-field print-col-50"><span class="print-label">District:</span><span class="print-value" data-field="district"></span></div>
        </div>
    </div>

    <div class="print-box">
        <div class="print-row-group" style="margin-bottom: 0;">
            <div class="print-field print-col-50"><span class="print-label">Father's Cell No.:</span><span class="print-value" data-field="fcontact"></span></div>
            <div class="print-field print-col-50"><span class="print-label">Mother's Cell No.:</span><span class="print-value" data-field="mcontact"></span></div>
        </div>
    </div>

    <div class="print-box">
        <div class="print-row-group" style="margin-bottom: 0;">
            <div class="print-field print-col-50"><span class="print-label">Aadhaar Number:</span><span class="print-value" data-field="aadhaar"></span></div>
            <div class="print-field print-col-50"><span class="print-label">Date of Birth (in figures):</span><span class="print-value" data-field="dob"></span></div>
        </div>
        <div class="print-field" style="width: 100%; margin-bottom: 0;"><span class="print-label">Date of Birth in Words:</span><span class="print-value" data-field="dob_words"></span></div>
    </div>

    <div class="print-box">
        <div class="print-row-group" style="margin-bottom: 0;">
            <div class="print-field print-col-50"><span class="print-label">Bank Account Number:</span><span class="print-value" data-field="bank_account"></span></div>
            <div class="print-field print-col-50"><span class="print-label">Bank Name:</span><span class="print-value" data-field="bank_branch"></span></div>
            <div class="print-field print-col-50"><span class="print-label">IFSC Code:</span><span class="print-value" data-field="ifsc_code"></span></div>
        </div>
    </div>

    <div class="print-box">
        <div class="print-row-group" style="margin-bottom: 0;">
            <div class="print-field print-col-50"><span class="print-label">Category:</span><span class="print-value" data-field="category" style="width: auto;"></span></div>
            <div class="print-field print-col-50"><span class="print-label">Blood Group:</span><span class="print-value" data-field="bloodgroup" style="width: auto;"></span></div>
        </div>
        <div class="print-row-group" style="margin-bottom: 0;">
            <div class="print-field print-col-50"><span class="print-label">Ration Card Number:</span><span class="print-value" data-field="ration_no"></span></div>
            <div class="print-field print-col-50"><span class="print-label">Ration Card Type:</span><span class="print-value" data-field="ration_type"></span></div>
        </div>
    </div>
    
    <div class="print-box" id="class-joining-box">
        <div class="print-row-group" style="margin-bottom: 0;">
            <div class="print-field print-col-50"><span class="print-label">Class Joining:</span><span class="print-value" data-field="class"></span></div>
            <div class="print-field print-col-50"><span class="print-label">PEN Number for Transferring Students:</span><span class="print-value" data-field="pen_number"></span></div>
        </div>
    </div>

    <div class="page-break"></div> 

    <h4 style="margin-top: 15px; margin-bottom: 5px; text-decoration: underline;">Parents Declaration</h4>
    <p style="text-align:justify; font-size:11px;">
        I do hereby declare that the above information provided by me is true to the best of my knowledge and belief. 
        I further declare that I will abide by the rules and regulations laid down by the school and the department from 
        time to time and I will co-operate with the institution for the betterment of my ward and institution under rules 
        when sought. I hereby declare that as the Parent of above mentioned student I am giving my consent to provide 
        the AADHAAR for the demographic authentication of the student. (Agreed: <span data-field="agree" style="font-weight: bold;"></span>)
    </p>

    <h4 style="margin-top: 15px; margin-bottom: 5px; text-decoration: underline;">For Office Use Only</h4>
    <p style="font-size: 11px;">The Student is admitted to Class <span class="print-value" style="min-width: 50px;">________</span> under Admission No. <span class="print-value" style="min-width: 50px;">________</span> on <span class="print-value" style="min-width: 70px;">________</span>. 
        All required documents, including the Birth Certificate, Residence Proof, and Transfer Certificate (if applicable), have been duly verified and found satisfactory.</p>


    <div class="signature-area">
        <div class="signature-box">Sign. of Parent</div>
        <div class="signature-box">Sign. of Adm. Incharge</div>
        <div class="signature-box">Sign. of HoI</div>
    </div>

</div>


<div id="apaarTemplate" class="apaar-form-template" style="display: none; border: 1px solid #000;">
    <div class="pdf-header-content" style="border-bottom: none; margin-top: 0;">
        <div class="school-logo" style="height: 50px; width: 50px;"> [Logo] </div>
        <div class="header-text" style="text-align: center; padding-top: 0;">
            <h3>GOVERNMENT PRIMARY SCHOOL</h3>
            <h3 style="margin-top: 0;">PETHGAM WAGOORA</h3>
            <p style="font-size: 9px;">Wagoora Babareshi Road Near ZEO Office Wagoora<br> UDISE CODE 01022202207 Email: pspethgam@gmail.com</p>
        </div>
    </div>

    <h3 style="margin-top: 10px;">Consent by Father/Mother/Legal Guardian of Student for APAAR ID Generation</h3>
    <p style="font-size: 11px;">Consent by Father/Mother/Legal Guardian of <span class="print-value" data-field="sname_full">...</span> as the <span class="print-value" data-field="fname_full">...</span> (Father / Mother / Legal Guardian) of <span class="print-value">...</span> (Aadhaar / PAN / EPIC Voter ID / Driving License / Passport) and identity Proof Number <span class="print-value" data-field="aadhaar">...</span> voluntarily give my consent to share his/her Aadhaar Number and demographic information issued by UIDAI with Ministry of Education for the sole purpose of creation of APAAR ID and opening of DIGILOCKER account of my child for the following intents and purposes.</p>
    <p style="font-size: 11px;">I understand that my APAAR ID may be used for limited purposes as may be notified by Ministry of Education from time-to-time for educational and related activities. Further I am also aware that my personal identifiable information (Name, Address, Age, Date of Birth, Gender and Photograph) may be made available to entities engaged in various educational activities such as UDISE+ database, scholarships, maintenance academic records, other stakeholders like Educational Institutions and recruitment agencies.</p>
    <p style="font-size: 11px;">I authorise Ministry of Education to use my Aadhaar number for performing Aadhaar based authentication with UIDAI as per provision of the Aadhaar (Targeted Delivery of Financial and Other Subsidies, Benefits, and Services) Act, 2016 for the aforesaid purpose. I understand that UIDAI will share my e-KYC details, or response of "Yes" with Ministry of Education upon successful authentication.</p>
    <p style="font-size: 11px;">I understand that the information shared by me shall be kept **Confidential** and shall not be divulged to any third party except as may be required by law.</p>
    <p style="font-size: 11px;">I understand that I can withdraw my consent for all or any of the purposes at any time by and on withdrawal of my consent, the processing of my shared information will stop, however, any personal data already been processed shall remain unaffected on such withdrawal of consent.</p>

    <div style="display: flex; justify-content: space-between; margin-top: 30px; font-size: 11px;">
        <div>Place of Physical Consent: <span class="print-value" data-field="district">...</span></div>
        <div>Signature or Parent Guardian: <span class="print-value" style="min-width: 150px;"></span></div>
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 11px;">
        <div>Date of Physical Consent: <span class="print-value" style="min-width: 150px;">...</span></div>
        <div></div>
    </div>
    
    <p style="text-align: center; margin: 20px 0; font-weight: bold;">********************Consent by Head of the School********************</p>
    <p style="font-size: 11px;">I **Mohmad Ashraf Rather** as Head of the School or any authorized teacher/staff hereby declare that the Father/Mother/Legal Guardian of <span class="print-value" data-field="sname_full">...</span> as mentioned above has given the Consent for Providing AADHAAR to create APAAR ID, opening of DIGILOCKER Account and Identity Verification in UDISE Plus Date:</p>

    <div style="display: flex; justify-content: space-between; margin-top: 30px; font-size: 11px;">
        <div style="padding-top: 5px; min-width: 100px;">Date: <span class="print-value" style="min-width: 100px;"></span></div>
        <div style="border-top: 1px solid #000; padding-top: 5px; min-width: 150px; text-align: center;">Signature of HoI</div>
    </div>
</div>


<script>
    const { jsPDF } = window.jspdf;
    let admittedStudents = []; 
    let lastSubmittedData = null; 

    // --- Tab Switching Logic ---
    function showTab(tabId, button) {
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelectorAll('.tab-buttons button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        button.classList.add('active');
    }

    // --- Data Extraction ---
    function extractFormDataForPDF(formId) {
        const form = document.getElementById(formId);
        const data = {};
        const elements = form.querySelectorAll('input, select, textarea');

        elements.forEach(element => {
            if (element.name) {
                if (element.type === 'checkbox') {
                    data[element.name] = element.checked ? 'Yes' : 'No';
                } else if (element.type === 'file') {
                    data[element.name] = 'File uploaded'; 
                } else if (element.tagName === 'SELECT' && element.options[element.selectedIndex]) {
                    data[element.name] = element.options[element.selectedIndex].text;
                } else {
                    data[element.name] = element.value;
                }
            }
        });
        
        // Ensure 'agree' checkbox is captured correctly
        data['agree'] = form.querySelector('#agree') ? (form.querySelector('#agree').checked ? 'Agreed' : 'Not Agreed') : 'N/A';
        
        // Using the single-line input values directly for the PDF template fields
        // This ensures the full name is captured as one string
        // The .trim().replace(/\s+/g, ' ') ensures cleaner data
        data['sname_full'] = data.sname_full ? data.sname_full.trim().replace(/\s+/g, ' ') : '____________________';
        data['aname_full'] = data.aname_full ? data.aname_full.trim().replace(/\s+/g, ' ') : '____________________';
        data['fname_full'] = data.fname_full ? data.fname_full.trim().replace(/\s+/g, ' ') : '____________________';
        data['mname_full'] = data.mname_full ? data.mname_full.trim().replace(/\s+/g, ' ') : '____________________';
        
        data['class'] = data.class || 'N/A';

        return data;
    }
    
    // --- PDF Template Creation FIX ---
    function createPrintableContent(elementId, formData) {
        const originalElement = document.getElementById(elementId);
        // Clone the element from the hidden template
        const clone = originalElement.cloneNode(true);
        clone.id = 'tempPdfContent_' + elementId;
        
        // Temporarily make the clone visible for html2canvas to render
        clone.style.display = 'block'; 
        clone.style.position = 'absolute'; // Position off-screen to prevent visual flash on the page
        clone.style.top = '-9999px'; 
        clone.style.left = '-9999px'; 

        // Fill in the static lines with form data
        clone.querySelectorAll('[data-field]').forEach(span => {
            const fieldName = span.getAttribute('data-field');
            span.textContent = formData[fieldName] || '____________________'; 
        });

        document.body.appendChild(clone);
        return clone;
    }


    /**
     * Generates PDF with compact A4 scaling and template selection.
     */
    function generatePDF(elementId, fileName) {
        const formData = lastSubmittedData; 

        if (!formData || Object.keys(formData).length === 0) {
             alert("Error: Please submit the Admission Form first to populate data for this download. You must fill out and submit the form successfully before downloading.");
             return;
        }
        
        // Hide print-exclude elements before capture
        const exclusions = document.querySelectorAll('.print-exclude');
        exclusions.forEach(el => el.classList.add('hidden-for-print')); 

        let elementToCapture = (elementId === 'printFormTemplate' || elementId === 'apaarTemplate') 
            ? createPrintableContent(elementId, formData) 
            : document.getElementById(elementId);

        const pdfMargin = 5; 
        const pdf = new jsPDF('p', 'mm', 'a4'); 
        const a4Width = 210;
        const contentWidth = a4Width - (2 * pdfMargin); 

        html2canvas(elementToCapture, { 
            scale: 3, 
            allowTaint: true,
            useCORS: true,
            windowHeight: elementToCapture.scrollHeight 
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            
            const scaleFactor = contentWidth / canvas.width;
            const imgHeight = canvas.height * scaleFactor;
            
            let heightLeft = imgHeight;
            let position = 0;

            // Add first page
            pdf.addImage(imgData, 'PNG', pdfMargin, pdfMargin, contentWidth, imgHeight);
            
            heightLeft -= (297 - pdfMargin); 
            position -= (297 - pdfMargin); 

            // Handle multi-page content
            while (heightLeft > 0) {
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', pdfMargin, position + pdfMargin, contentWidth, imgHeight); 
                heightLeft -= 297; 
                position -= 297; 
            }

            pdf.save(fileName);
        }).finally(() => {
            // IMPORTANT: Clean up the temporary content and restore hidden elements
            if (elementToCapture && elementToCapture.id.startsWith('tempPdfContent_')) {
                elementToCapture.remove();
            }
            exclusions.forEach(el => el.classList.remove('hidden-for-print'));
        });
    }

    // --- Submission Logic ---
    document.getElementById("admissionForm").addEventListener("submit", function(e){
        // PREVENT DEFAULT: This is the critical line that stops the page reload/disappearing preview
        e.preventDefault(); 
        
        const form = e.target;
        const formData = extractFormDataForPDF(form.id);
        
        lastSubmittedData = formData;

        const appId = Date.now(); 
        
        const date = new Date().toISOString().slice(0, 10);
        const newRecord = {
            id: appId, 
            sno: admittedStudents.filter(r => r.status !== 'Rejected' && r.status !== 'Deleted').length + 1,
            dateOfSubmission: date,
            studentName: formData.sname_full,
            dob: formData.dob,
            fatherName: formData.fname_full,
            classJoining: formData.class,
            parentsContact: formData.fcontact,
            status: 'In Progress', 
            raw_data: formData 
        };

        admittedStudents.push(newRecord);
        updateRegisterTable();
        
        alert(`Admission Form submitted successfully. Student: ${newRecord.studentName} added to the Register for review.\n\nNOTE: The form data is now available for PDF download.`);
        
        // Optional: Clear form fields after successful submission
        // form.reset(); 
    });

    // --- APAAR Button Logic ---
    document.getElementById("openApaarForm").addEventListener("click", function() {
        const form = document.getElementById('admissionForm');
        
        if (!form.checkValidity()) {
            form.reportValidity();
            alert("Please fill out all required fields before proceeding to the APAAR form.");
            return;
        }

        // Capture data without submitting
        lastSubmittedData = extractFormDataForPDF('admissionForm');
        alert("APAAR Consent Form data is successfully loaded. Please click 'Download APAAR Consent Form' below to generate the PDF.");
    });

    // --- Register Table Logic ---

    function handleRegisterAction(id, action) {
        const index = admittedStudents.findIndex(record => record.id === id);
        if (index === -1) return;

        const record = admittedStudents[index];

        switch(action) {
            case 'accept':
                if (record.status !== 'Admitted') {
                    record.status = 'Admitted';
                    record.dateOfAdmission = new Date().toISOString().slice(0, 10);
                    alert(`Application for ${record.studentName} **Accepted** and Admitted!`);
                }
                break;
            case 'reject':
                if (record.status !== 'Rejected') {
                    record.status = 'Rejected';
                    alert(`Application for ${record.studentName} **Rejected**!`);
                }
                break;
            case 'delete':
                admittedStudents.splice(index, 1); // Remove the record
                alert(`Application for ${record.studentName} **Deleted** permanently.`);
                break;
        }
        updateRegisterTable();
    }

    function updateRegisterTable() {
        const body = document.getElementById('registerBody');
        body.innerHTML = ''; 

        // Initial Sample Data (Only add samples if the array is empty)
        if (admittedStudents.length === 0) {
             admittedStudents.push({
                id: 100, dateOfSubmission: '2025-07-01', studentName: 'Ayesha Bhat', dob: '2019-01-15', fatherName: 'Ghulam Mohd Bhat', classJoining: '3rd', parentsContact: '9876543210', status: 'Admitted', raw_data: {sname_full: 'Ayesha Bhat', fname_full: 'Ghulam Mohd Bhat', dob: '2019-01-15', class: '3rd', fcontact: '9876543210'}
            });
            admittedStudents.push({
                id: 101, dateOfSubmission: '2025-07-05', studentName: 'Danish Lone', dob: '2020-05-20', fatherName: 'Abdul Ahad Lone', classJoining: '1st', parentsContact: '9988776655', status: 'In Progress', raw_data: {sname_full: 'Danish Lone', fname_full: 'Abdul Ahad Lone', dob: '2020-05-20', class: '1st', fcontact: '9988776655'}
            });
        }
        
        let displaySNo = 1;
        admittedStudents.forEach(record => {
            if (record.status === 'Deleted') return;

            const row = body.insertRow();
            row.setAttribute('data-status', record.status);
            
            row.insertCell().textContent = displaySNo++;
            row.insertCell().textContent = record.dateOfSubmission;
            row.insertCell().textContent = record.studentName;
            row.insertCell().textContent = record.dob;
            row.insertCell().textContent = record.fatherName;
            row.insertCell().textContent = record.classJoining;
            row.insertCell().textContent = record.parentsContact;
            
            const statusCell = row.insertCell();
            statusCell.textContent = record.status;
            statusCell.style.color = record.status === 'Admitted' ? 'green' : (record.status === 'Rejected' ? 'red' : 'orange');

            const actionCell = row.insertCell();
            actionCell.innerHTML = `
                <button class="action-btn accept" onclick="handleRegisterAction(${record.id}, 'accept')">Accept</button>
                <button class="action-btn reject" onclick="handleRegisterAction(${record.id}, 'reject')">Reject</button>
                <button class="action-btn delete" onclick="handleRegisterAction(${record.id}, 'delete')">Delete</button>
            `;
        });
        filterRegister();
    }

    function filterRegister() {
        const filterValue = document.getElementById('statusFilter').value;
        const rows = document.getElementById('registerBody').getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const status = rows[i].getAttribute('data-status');
            if (filterValue === 'All' || status === filterValue) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }

    // --- PDF Event Listeners ---
    document.getElementById("downloadForm").addEventListener("click", function(){
        generatePDF('printFormTemplate', 'Admission_Form_Hard_Copy.pdf');
    });

    document.getElementById("downloadRegister").addEventListener("click", function(){
        generatePDF('officeUseBox', 'Admission_Register_Record.pdf');
    });
    
    document.getElementById("downloadApaar").addEventListener("click", function(){
        generatePDF('apaarTemplate', 'APAAR_Consent_Form.pdf');
    });

    // Globalizing the action function for inline HTML calls
    window.handleRegisterAction = handleRegisterAction; 

    // Initialize the Register table and show the default tab
    updateRegisterTable(); 
    showTab('admissionFormTab', document.querySelector('.tab-buttons button:first-child'));

</script>

</body>
</html>      
