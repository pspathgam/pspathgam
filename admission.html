<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admission Management - GPS Pethgam Wagoora</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body{
        font-family: Arial, sans-serif;
        background:#eef7ff;
        margin:0;
        padding:20px;
    }

    .tab-buttons{
        display:flex;
        gap:10px;
        margin-bottom:20px;
        justify-content: center;
    }

    /* 3D LOOKING BUTTONS */
    .tab-buttons button{
        background:#0b76ef;
        color:white;
        padding:10px 22px;
        border:none;
        border-radius:6px;
        font-weight:bold;
        cursor:pointer;
        box-shadow:0px 4px 0px #064a97;
        transition:0.1s;
    }
    .tab-buttons button:hover:not(.active) {
        background: #0066cc;
    }
    .tab-buttons button.active {
        background: #004d99;
        box-shadow:0px 2px 0px #064a97;
    }
    .tab-buttons button:active{
        box-shadow:0px 1px 0px #064a97;
        transform:translateY(3px);
    }

    /* Tab Content Styling */
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* --- LOGO AND HEADER STYLES --- */
    .header-content {
        display: flex;
        align-items: center; 
        justify-content: center; 
        margin-bottom: 20px;
        text-align: center;
        border-bottom: 2px solid #ccc;
        padding-bottom: 15px;
    }

    .school-logo {
        height: 80px; 
        width: 80px; 
        margin-right: 20px;
        border: 1px solid #ccc; 
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 10px;
        color: #555;
        font-weight: bold;
    }

    .header-text {
        text-align: left;
    }

    h2{
        margin-top:0;
        margin-bottom: 5px; 
        font-size: 24px;
        color: #0b76ef;
    }
    .header-text p {
        margin: 0;
        font-size: 12px;
        color: #555;
    }
    /* -------------------------------- */

    .container{
        background:white;
        padding:20px;
        border-radius:8px;
        box-shadow:0px 0px 10px #bcd4ff;
        max-width:850px; 
        margin:auto;
    }

    label{
        display:block;
        margin-top:10px;
        font-weight:bold;
    }

    /* Grid for multi-part names and contacts */
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
    }
    .form-group {
        flex: 1;
        min-width: 0;
    }
    .form-group label {
        margin-top: 0;
        font-size: 14px;
        font-weight: normal;
    }
    
    input, select{
        width:100%;
        padding:8px;
        margin-top:5px;
        border-radius:4px;
        border:1px solid #999;
        box-sizing: border-box;
    }

    textarea{
        width:100%;
        height:100px;
        border-radius:4px;
        border:1px solid #999;
        padding:8px;
        margin-top:5px;
        box-sizing: border-box;
    }

    .section-title{
        font-size:18px;
        margin-top:25px;
        font-weight:bold;
        text-decoration:underline;
        color: #0b76ef;
    }

    /* Download/Submit Buttons */
    .submit-btn{
        background:#28a745;
        color:white;
        padding:12px;
        border:none;
        border-radius:6px;
        width:100%;
        font-size:18px;
        margin-top:20px;
        cursor:pointer;
        font-weight:bold;
        box-shadow:0px 4px 0px #0c6c25;
        transition:0.1s;
    }
    .submit-btn:active{
        box-shadow:0px 1px 0px #0c6c25;
        transform:translateY(3px);
    }
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: center;
    }
    .pdf-btn {
        background:#dc3545;
        color:white;
        padding:10px 15px;
        border:none;
        border-radius:6px;
        font-weight:bold;
        cursor:pointer;
        box-shadow:0px 4px 0px #970617;
        transition:0.1s;
        font-size: 16px;
        flex-grow: 1;
        max-width: 380px;
    }
    .pdf-btn:active{
        box-shadow:0px 1px 0px #970617;
        transform:translateY(3px);
    }

    /* OFFICE USE BOX */
    .office-use-box{
        background:#fff;
        border:2px dashed #0066cc;
        padding:20px;
        max-width:850px;
        margin:25px auto;
        border-radius:8px;
    }

    /* Register Table Styling */
    .register-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 14px;
    }
    .register-table th, .register-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    .register-table th {
        background-color: #f2f2f2;
        font-weight: bold;
        position: sticky;
        top: 0;
    }
    .register-table img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
    }
</style>

</head>
<body>

<div class="tab-buttons">
    <button class="active" onclick="showTab('admissionFormTab', this)">Admission Form</button>
    <button onclick="showTab('admissionRegisterTab', this)">Admission Register</button>
    <button onclick="alert('Search functionality coming soon!')">Search Student</button>
</div>

<div id="admissionFormTab" class="tab-content active">
    
    <div class="container" id="admissionFormContainer"> 
        
        <div class="header-content">
            <div class="school-logo">
                [Logo]
            </div>
            <div class="header-text">
                <h2>GOVERNMENT PRIMARY SCHOOL PETHGAM WAGOORA</h2>
                <p>Wagoora Babareshhi Road Near Zonal Education Office Wagoora<br>
                **Email ID: psspethgam@gmail.com. UDISECode: 01022202207**</p>
            </div>
        </div>
        
        <h3 style="text-align:center;">ADMISSION FORM</h3>

        <form id="admissionForm">

            <label>Students Name</label>
            <div class="form-row">
                <div class="form-group"><input type="text" name="sname_first" required><label>First Name</label></div>
                <div class="form-group"><input type="text" name="sname_middle"><label>Middle Name</label></div>
                <div class="form-group"><input type="text" name="sname_last" required><label>Last Name</label></div>
            </div>

            <label>Name As Per Aadhaar</label>
            <div class="form-row">
                <div class="form-group"><input type="text" name="aname_first"><label>First Name</label></div>
                <div class="form-group"><input type="text" name="aname_middle"><label>Middle Name</label></div>
                <div class="form-group"><input type="text" name="aname_last"><label>Last Name</label></div>
            </div>

            <label>Father's Name</label>
            <div class="form-row">
                <div class="form-group"><input type="text" name="fname_first" required><label>First Name</label></div>
                <div class="form-group"><input type="text" name="fname_middle"><label>Middle Name</label></div>
                <div class="form-group"><input type="text" name="fname_last" required><label>Last Name</label></div>
            </div>

            <label>Mother's Name</label>
            <div class="form-row">
                <div class="form-group"><input type="text" name="mname_first" required><label>First Name</label></div>
                <div class="form-group"><input type="text" name="mname_middle"><label>Middle Name</label></div>
                <div class="form-group"><input type="text" name="mname_last" required><label>Last Name</label></div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Residence</label>
                    <input type="text" name="residence" required>
                </div>
                <div class="form-group">
                    <label>District</label>
                    <input type="text" name="district" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Father's Contact Number</label>
                    <input type="text" name="fcontact" required>
                </div>
                <div class="form-group">
                    <label>Mother's Contact Number</label>
                    <input type="text" name="mcontact">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Aadhaar Number</label>
                    <input type="text" name="aadhaar" maxlength="12">
                </div>
                <div class="form-group">
                    <label>Date of Birth (in figures)</label>
                    <input type="date" name="dob" required>
                </div>
            </div>
            <label>Date of Birth in Words</label>
            <input type="text" name="dob_words">

            <div class="form-row">
                <div class="form-group">
                    <label>Bank Account Number</label>
                    <input type="text" name="bank_account">
                </div>
                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" name="bank_name">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Bank Branch</label>
                    <input type="text" name="bank_branch">
                </div>
                <div class="form-group">
                    <label>IFSC Code</label>
                    <input type="text" name="ifsc_code">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Category</label>
                    <select name="category">
                        <option>SC</option>
                        <option>ST</option>
                        <option>OBC</option>
                        <option>GENERAL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Blood Group</label>
                    <select name="bloodgroup">
                        <option value="">Select</option>
                        <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                        <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Ration Card Number</label>
                    <input type="text" name="ration_no">
                </div>
                <div class="form-group">
                    <label>Ration Card Type</label>
                    <input type="text" name="ration_type">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Class Joining</label>
                    <select name="class" required>
                        <option value="">Select Class</option>
                        <option>Nursery</option><option>LKG</option><option>UKG</option>
                        <option>1st</option><option>2nd</option><option>3rd</option>
                        <option>4th</option><option>5th</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>PEN Number for Transferring Students</label>
                    <input type="text" name="pen_number">
                </div>
            </div>

            <label>Student Photo</label>
            <input type="file" name="student_photo" accept="image/*">
            
            <p class="section-title">Parents Declaration</p>
            <p style="text-align:justify; font-size:14px;">
                I do hereby declare that the above information provided by me is true to the best of my knowledge and belief. 
                I further declare that I will abide by the rules and regulations laid down by the school and the department from 
                time to time and I will co-operate with the institution for the betterment of my ward and institution under rules 
                when sought. I hereby declare that as the Parent of above mentioned student I am giving my consent to provide 
                the AADHAAR for the demographic authentication of the student.
            </p>

            <label style="margin-top: 15px;">
                <input type="checkbox" id="agree" required>
                I agree to the above declaration.
            </label>

            <button type="submit" class="submit-btn">Submit Admission Form & Proceed to APAAR</button>
        </form>

        <div class="office-use-box" id="officeUseBox" style="margin-top: 25px;">
            <h3 style="text-align:center; margin-top:0;">OFFICE USE ONLY</h3>
            <label>Admission No. Allotted</label>
            <input type="text" name="allotted_adm_no" placeholder="To be filled by Office">

            <div class="form-row">
                <div class="form-group">
                    <label>Class Admitted To</label>
                    <input type="text" name="admitted_class">
                </div>
                <div class="form-group">
                    <label>Date of Admission</label>
                    <input type="date" name="admission_date">
                </div>
            </div>

            <p style="margin-top:15px;font-weight:bold; font-size:14px;">
                The Student is admitted to Class <span style="text-decoration: underline;">________</span> under Admission No. <span style="text-decoration: underline;">________</span> on <span style="text-decoration: underline;">________</span>. 
                All required documents, including the Birth Certificate, Residence Proof, and Transfer Certificate (if applicable), 
                have been duly verified and found satisfactory.
            </p>

            <div class="form-row" style="margin-top: 30px;">
                <div class="form-group"><input type="text"><label>Signature of Parent</label></div>
                <div class="form-group"><input type="text"><label>Sig. Of Adm. Incharge</label></div>
                <div class="form-group"><input type="text"><label>Sig. Of Headmaster</label></div>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: 20px;">
        <p style="text-align: center; font-weight: bold; margin-bottom: 10px;">Download Options (Use after Submission)</p>
        <div class="action-buttons">
            <button id="downloadForm" class="pdf-btn" data-target="admissionFormContainer">Generate & Download PDF Admission Form (Pre-filled)</button>
            <button id="downloadRegister" class="pdf-btn" data-target="officeUseBox">Generate & Download PDF Register Record</button>
        </div>
    </div>
</div>

<div id="admissionRegisterTab" class="tab-content">
    <div class="container">
        <h3 style="text-align:center;">ADMITTED STUDENT REGISTER</h3>
        <p style="font-weight: bold;">Filter by Status: 
            <select id="statusFilter" onchange="filterRegister()">
                <option value="All">All</option>
                <option value="Admitted">Admitted</option>
                <option value="In Progress">In Progress</option>
            </select>
        </p>

        <div style="max-height: 500px; overflow-y: auto;">
            <table class="register-table">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Date of Admission</th>
                        <th>Student Name</th>
                        <th>DOB</th>
                        <th>Father's Name</th>
                        <th>Mother's Name</th>
                        <th>Parents Contact</th>
                        <th>Parents Profession</th>
                        <th>Status of Admission</th>
                        <th>Photo</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody id="registerBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>


<script>
    const { jsPDF } = window.jspdf;
    let admittedStudents = []; // Array to hold submitted form data

    // --- Tab Switching Logic ---
    function showTab(tabId, button) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab-buttons button').forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(tabId).classList.add('active');
        button.classList.add('active');
    }

    // --- Data Extraction for PDF ---
    function extractFormDataForPDF(formId) {
        const form = document.getElementById(formId);
        const data = {};
        const elements = form.querySelectorAll('input, select, textarea');

        elements.forEach(element => {
            if (element.name && element.name !== 'agree') {
                if (element.type === 'checkbox') {
                    data[element.name] = element.checked ? 'Yes' : 'No';
                } else if (element.type === 'file') {
                    // Skip file inputs
                } else {
                    data[element.name] = element.value;
                }
            }
        });
        // Include the declaration checkbox status manually if not captured above
        data['agree'] = form.querySelector('#agree') ? form.querySelector('#agree').checked : false;
        return data;
    }
    
    // --- Temporary Content Creation for PDF (Pre-filled data) ---
    function createPreFilledContent(elementId, formData) {
        const originalElement = document.getElementById(elementId);
        const clone = originalElement.cloneNode(true);
        clone.id = 'tempPdfContent';
        clone.style.maxWidth = '210mm'; 
        clone.style.padding = '10mm';
        
        // Remove interactive elements
        clone.querySelector('button.submit-btn')?.remove();
        clone.querySelector('.action-buttons')?.remove();
        
        // Handle declaration checkbox display
        const declarationCheckbox = clone.querySelector('#agree');
        if(declarationCheckbox) {
            const labelNode = declarationCheckbox.closest('label');
            if (labelNode) {
                labelNode.textContent = `I agree to the above declaration. (Status: ${formData['agree'] ? 'Agreed' : 'Not Agreed'})`;
            }
        }

        // Replace inputs/selects/textareas with their static values
        const inputs = clone.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            const name = input.name;
            let value = formData[name] || '';
            
            // For selects, display the text of the selected option if available
            if (input.tagName === 'SELECT' && input.options[input.selectedIndex]) {
                value = input.options[input.selectedIndex].text;
            }

            const textDisplay = document.createElement('span');
            textDisplay.style.borderBottom = '1px dashed #000';
            textDisplay.style.padding = '2px 5px';
            textDisplay.style.display = 'inline-block';
            textDisplay.style.minWidth = '50px';
            textDisplay.textContent = value;
            
            input.parentNode.insertBefore(textDisplay, input);
            input.remove();
        });

        document.body.appendChild(clone);
        return clone;
    }


    /**
     * FIX: Generates PDF, ensuring A4 size and checking for submission data.
     */
    function generatePDF(elementId, fileName) {
        if (elementId === 'admissionFormContainer' && admittedStudents.length === 0) {
            alert("Error: Please submit the Admission Form first before attempting to download the pre-filled PDF.");
            return;
        }

        const formId = 'admissionForm';
        // Use the latest submitted data for the form PDF
        const formData = admittedStudents.length > 0 ? admittedStudents[admittedStudents.length - 1].raw_data : extractFormDataForPDF(formId);
        
        let elementToCapture;
        
        if (elementId === 'admissionFormContainer') {
            elementToCapture = createPreFilledContent(elementId, formData);
        } else {
            elementToCapture = document.getElementById(elementId);
        }

        html2canvas(elementToCapture, { 
            scale: 3, // High scale for better print quality
            allowTaint: true,
            useCORS: true 
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); 

            // A4 Dimensions in mm (FIXED for Print)
            const pdfWidth = 210; 
            const pdfHeight = 297; 
            
            const imgHeight = canvas.height * pdfWidth / canvas.width;
            
            let heightLeft = imgHeight;
            let position = 0;

            // Add first page
            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;

            // Handle multi-page content
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
            }

            pdf.save(fileName);
        }).finally(() => {
            // Clean up the temporary content
            if (elementToCapture && elementToCapture.id === 'tempPdfContent') {
                elementToCapture.remove();
            }
        });
    }

    // --- Submission Logic (FIX: Ensures submitted form appears in Register) ---
    document.getElementById("admissionForm").addEventListener("submit", function(e){
        e.preventDefault();
        
        const form = e.target;
        const formData = extractFormDataForPDF(form.id);

        // APAAR Form Simulation
        alert(`Admission Form Submitted. Data temporarily saved.\n\nSimulating Redirection to APAAR ID Generation Consent Form.\n\n***(In a real system, a new window or modal with the APAAR consent form would open here.)***`);
        
        // FIX: Prepare data for Register, including the submitted form data
        const date = new Date().toISOString().slice(0, 10);
        const newRecord = {
            sno: admittedStudents.length + 1,
            dateOfAdmission: date,
            // Concatenate name parts for display
            studentName: `${formData.sname_first} ${formData.sname_middle ? formData.sname_middle + ' ' : ''}${formData.sname_last}`,
            dob: formData.dob,
            fatherName: `${formData.fname_first} ${formData.fname_last}`,
            motherName: `${formData.mname_first} ${formData.mname_last}`,
            parentsContact: formData.fcontact,
            parentsProfession: 'N/A', 
            status: 'In Progress', 
            photo: 'placeholder',
            remarks: 'Submitted waiting for document verification.',
            raw_data: formData // Store original data for PDF generation
        };

        admittedStudents.push(newRecord);
        updateRegisterTable(); // Refresh the table view immediately
        
        alert(`Data saved successfully! Student: ${newRecord.studentName} added to the Admission Register. You can now download the PDF forms.`);

        form.reset();
    });

    // --- Register Table Logic ---
    function updateRegisterTable() {
        const body = document.getElementById('registerBody');
        body.innerHTML = ''; 

        // Initial Sample Data (Only add samples if the array is empty)
        if (admittedStudents.length === 0) {
             admittedStudents.push({
                sno: 1, dateOfAdmission: '2025-07-01', studentName: 'Ayesha Bhat', dob: '2019-01-15', fatherName: 'Ghulam Mohd Bhat', motherName: 'Zehra Begum', parentsContact: '9876543210', parentsProfession: 'Teacher', status: 'Admitted', photo: 'placeholder', remarks: 'TC received.', raw_data: {}
            });
            admittedStudents.push({
                sno: 2, dateOfAdmission: '', studentName: 'Danish Lone', dob: '2020-05-20', fatherName: 'Abdul Ahad Lone', motherName: 'Fatima Jan', parentsContact: '9988776655', parentsProfession: 'Farmer', status: 'In Progress', photo: 'placeholder', remarks: 'Aadhaar verification pending.', raw_data: {}
            });
        }

        admittedStudents.forEach(record => {
            const row = body.insertRow();
            row.setAttribute('data-status', record.status);
            
            row.insertCell().textContent = record.sno;
            row.insertCell().textContent = record.dateOfAdmission;
            row.insertCell().textContent = record.studentName;
            row.insertCell().textContent = record.dob;
            row.insertCell().textContent = record.fatherName;
            row.insertCell().textContent = record.motherName;
            row.insertCell().textContent = record.parentsContact;
            row.insertCell().textContent = record.parentsProfession;
            
            const statusCell = row.insertCell();
            statusCell.textContent = record.status;
            statusCell.style.color = record.status === 'Admitted' ? 'green' : 'orange';

            const photoCell = row.insertCell();
            photoCell.innerHTML = '<img style="width: 24px; height: 24px;" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDExQzE0LjIwOTEgMTQgMTQuOSA5LjggMTUgMTJDLTEuNjY2NjcgMTIgOS4yNDY4NyAxMiAxMiAxM1oiIHN0cm9rZT0iIzMyMzIzMiIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI5IiBzdHJva2U9IiMzMjMyMzIiIHN0cm9rZS13aWR0aD0iMS41Ii8+Cjwvc3ZnPgo=" alt="Photo" />';

            row.insertCell().textContent = record.remarks;
        });
        filterRegister();
    }

    function filterRegister() {
        const filterValue = document.getElementById('statusFilter').value;
        const rows = document.getElementById('registerBody').getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const status = rows[i].getAttribute('data-status');
            if (filterValue === 'All' || status === filterValue) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }

    // --- PDF Event Listeners ---
    document.getElementById("downloadForm").addEventListener("click", function(){
        generatePDF('admissionFormContainer', 'Admission_Form_Pre_filled.pdf');
    });

    document.getElementById("downloadRegister").addEventListener("click", function(){
        generatePDF('officeUseBox', 'Admission_Register_Record.pdf');
    });
    
    // Initialize the Register table and show the default tab
    updateRegisterTable(); 
    showTab('admissionFormTab', document.querySelector('.tab-buttons button:first-child'));

</script>

</body>
</html>

            
